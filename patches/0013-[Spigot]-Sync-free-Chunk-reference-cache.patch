From e35b3899f68a3f8d2563a5c31d4d4370d57c0e54 Mon Sep 17 00:00:00 2001
From: Ribesg <Ribesg@yahoo.fr>
Date: Sun, 7 Apr 2014 13:47:18 +0200
Subject: [PATCH] Sync-free Chunk reference cache.

https://github.com/SpigotMC/Spigot/blob/master/CraftBukkit-Patches/0013-Sync-Free-Chunk-Reference-Cache.patch

Modified files:
- src/main/java/net/minecraft/server/World.java

diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index 1ed1e27..d2679dc 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -291,20 +291,18 @@ public abstract class World implements IBlockAccess {
         return this.getChunkAt(i >> 4, j >> 4);
     }
 
+    // Nukkit start
     public Chunk getChunkAt(int i, int j) {
-        // CraftBukkit start
-        Chunk result = null;
-        synchronized (this.chunkLock) {
-            if (this.lastChunkAccessed == null || this.lastXAccessed != i || this.lastZAccessed != j) {
-                this.lastChunkAccessed = this.chunkProvider.getOrCreateChunk(i, j);
-                this.lastXAccessed = i;
-                this.lastZAccessed = j;
-            }
-            result = this.lastChunkAccessed;
+        //synchronized (this.chunkLock) {
+        Chunk result = this.lastChunkAccessed; // Exploit fact that read is atomic
+        if (result == null || result.locX != i || result.locZ != j) {
+            result = this.chunkProvider.getOrCreateChunk(i, j);
+            this.lastChunkAccessed = result; // Exploit fact that write is atomic
         }
+        //}
         return result;
-        // CraftBukkit end
     }
+    // Nukkit end
 
     public boolean setTypeAndData(int i, int j, int k, Block block, int l, int i1) {
         if (i >= -30000000 && k >= -30000000 && i < 30000000 && k < 30000000) {
-- 
